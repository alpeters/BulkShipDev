---
title: "ML FC Exploration"
format: html
editor: visual
---

```{r}
library(tidyverse)
# library(kableExtra)
library(readr)
```

# Global params

```{r}
imagepath = "plots"
tablepath = "tables"
mltrackeddatapath = "tracked_data"
trackeddatapath = "../src/tracked_data"
fileprefix = "ML_FC_Exploration_"
set <- 'djdrank10_test2021_fast' # 'djbrank_9_test2021' #'m5dd_rel'
# fileprefix = "ML_FC_features_Exploration_"
# set <- 'djbrank_9_test2021' #'m5dd_rel'

# update_geom_defaults("text", list(size = 20))
base_size <- 18
theme_set(theme_minimal(base_size = base_size))
theme_pres <- function(base_size){
  theme_get() %+replace%
    theme(axis.ticks = element_line(colour = "grey70", linewidth = rel(0.5)),
          panel.grid = element_blank(),
          panel.grid.major.y = element_line(colour = 'grey90', linewidth = rel(0.5)),
          # panel.border = element_rect(fill = NA, colour = "grey30", linewidth = rel(0.8)),
          strip.text = element_text(size=1.03*base_size),
          legend.text = element_text(size=1.1*base_size))
}
pres_palette <- c("#482677FF", "#1D7C5A", "#A64902", "#e7298a")
```

# Functions

For tables

```{r}
sieve_cols <- function(mat){
  for(i in seq_len(ncol(mat))){
    col <- mat[,i]
    last_element <- max(which(col != ""))
    col <- c(rep(" ", length(col)-last_element), col[1:last_element])
    mat[,i] = col
  }
  return(mat)
}

make_header_rows <- function(colnames, sep = '_'){
  n_headers <- max(str_count(colnames, sep)) + 1
  header_rows <- str_split(colnames, sep, simplify=TRUE) |> 
    t() |> 
    sieve_cols() %>% 
  split(., row(.))
  return(header_rows)
}

list_subsequent_count <- function(l){
  count <- integer(length=length(l)) # max length of counts list (actual length unknowable a priori)
  value <- vector('list', length=length(count))
  reps = 1
  element = 1
  for(i in 1:(length(l)-1)){
    if(l[[i]] == l[[i+1]]){
      reps <- reps + 1
    }else{
      count[element] <- reps
      value[element] <- l[[i]]
      element <- element + 1
      reps = 1
    }
    count[element] <- reps
    value[element] <- l[[length(l)]]
  }
  names(count) <- value
  return(count[count != 0])
}

get_separate_headers <- function(df, sep = '_'){
  header_rows <- make_header_rows(colnames(df), sep = sep)
  rows_indexes <- lapply(header_rows[-length(header_rows)], list_subsequent_count)
  # print(rows_indexes)
  # return(rows_indexes)
  return(list(rows_indexes = rows_indexes, colnames = header_rows[[length(header_rows)]]))
}

add_headers_above <- function(kbl, headers, escape = FALSE){
  i = 1
  for(header in rev(headers)){
    # if(any(str_detect(names(header), '%'))){
    #   escape = TRUE
    # }else(
    #   escape = FALSE
    # )
    if(i == 1){
      line = TRUE
    }else{
        line = FALSE
    }
    kbl <- kbl |> 
      add_header_above(header, escape = escape, line = line)
    i = i + 1
  }
  return(kbl)
}
```

# Load data

```{r}
train_df <- read_csv('../src/tracked_data/df_ml_rel_train.csv',
                          show_col_types = FALSE)
```

# Features

```{r}
train_df |> 
  colnames() |> 
  as_tibble() |> 
  rename('variable' = 'value') |> 
  write_csv(file.path(tablepath, paste0(fileprefix, "all_feature_names.csv")))
```

## Manually create feature descriptions in csv, then load

```{r}
features_all_desc <- read_csv(file.path(tablepath, paste0(str_remove(fileprefix, '_features'), 'all_feature_names_desc.csv')))
```

```{r}
features_all_desc
```

### Feature description table

```{r}
features_set_desc <- paste0(str_remove(fileprefix, '_Exploration'), 'F', set, '_features.csv') %>%
  file.path(mltrackeddatapath, .) |> 
  read_csv(show_col_types = FALSE) |> 
  left_join(features_all_desc, by = 'variable') |> 
  mutate(group = factor(group, 
                        ordered = TRUE, 
                        levels = c('characteristic', 'activity', 'calc', 'quality'),
                        labels = c('Ship Characteristics', 'Ship Activity', 'Calculated', 'Data Quality'))) |> 
  arrange(group, name)

undefined <- features_set_desc |> 
  filter(is.na(name)) |> 
  pull(variable)

if(length(undefined) > 0){
  warning(paste('The following variables have no description:',
                paste(undefined, collapse = ', ')))
}

index_df <- features_set_desc |> 
  count(group)

index <- index_df$n
names(index) <- index_df$group

features_set_desc_table <- features_set_desc |>
  mutate(unit = ifelse(is.na(unit),
                            unit,
                            paste0('(', unit, ')'))) |> 
  mutate(across(everything(), \(x) replace_na(x, ''))) |> 
  mutate(table.desc = ifelse(calc_type == 'derived',
                             paste0(description, ', calculated as ', definition),
                             paste(description, unit))) |> 
  mutate(name = str_to_title(name),
         name = str_replace_all(name, 'Ais', 'AIS'),
         name = str_replace_all(name, 'Acs', 'acs'),
         name = str_replace_all(name, 'Fc', 'FC')) |> 
         # table.desc = str_to_sentence(table.desc)) |>
  select(Variable = name, Description = table.desc)

features_set_desc_table |>   
  kbl(digits = 0,
      format = 'latex',
      escape = FALSE,
      booktabs = TRUE) |>
  column_spec(1, width = "16em") |>
  column_spec(2, width = "30em") |> 
  pack_rows(index = index) |>
  save_kable(file.path(tablepath, paste0(fileprefix, 'features_', set, ".tex")),
             float = FALSE)

features_set_desc_table
```

### Feature description table (incremental groups) (TERRIBLE CODE!!)

```{r}
features_groups <- read_csv(file.path(mltrackeddatapath, 'ML_FC_variants.csv'), show_col_types = FALSE) |> 
  select(variable, djbrank, disjoint_b_name) |> 
  drop_na(disjoint_b_name) |> 
  mutate(disjoint_b_name = str_to_title(disjoint_b_name)) |> 
  arrange(djbrank)

features_set_desc <- paste0(str_remove(fileprefix, '_Exploration'), 'F', set, '_features.csv') %>%
  file.path(mltrackeddatapath, .) |> 
  read_csv(show_col_types = FALSE) |> 
  left_join(features_all_desc, by = 'variable') |> 
  select(-group) |> 
  left_join(features_groups, by = 'variable') |> 
  mutate(group = factor(djbrank, 
                        ordered = TRUE, 
                        levels = unique(features_groups$djbrank),
                        labels = unique(features_groups$disjoint_b_name)),
         .after = name) |> 
  arrange(group, name)
```

```{r}
features_set_desc
```

```{r}
features_set_desc |> arrange(group)

undefined <- features_set_desc |> 
  filter(is.na(name)) |> 
  pull(variable)

if(length(undefined) > 0){
  warning(paste('The following variables have no description:',
                paste(undefined, collapse = ', ')))
}

index_df <- features_set_desc |> 
  count(group)

index <- index_df$n
names(index) <- index_df$group
names(index) <- paste0(1:length(index), '. ', names(index))

features_set_desc_table <- features_set_desc |>
  mutate(unit = ifelse(is.na(unit),
                            unit,
                            paste0('(', unit, ')'))) |> 
  mutate(across(-c(group,djbrank), \(x) replace_na(x, ''))) |> 
  mutate(table.desc = ifelse(calc_type == 'derived',
                             paste0(description, ', calculated as ', definition),
                             paste(description, unit))) |> 
  mutate(name = str_to_title(name),
         name = str_replace_all(name, 'Ais', 'AIS'),
         name = str_replace_all(name, 'Acs', 'acs'),
         name = str_replace_all(name, 'Fc', 'FC')) |> 
         # table.desc = str_to_sentence(table.desc)) |>
  select(Variable = name, Description = table.desc)

features_set_desc_table |>   
  kbl(digits = 0,
      format = 'latex',
      escape = FALSE,
      booktabs = TRUE) |>
  column_spec(1, width = "16em") |>
  column_spec(2, width = "30em") |> 
  pack_rows(index = index) |> 
  save_kable(file.path(tablepath, paste0(fileprefix, 'features_groups_', set, ".tex")),
             float = FALSE)

features_set_desc_table
```

```{r}
test <- read_csv('../src/tracked_data/df_ml_rel_train.csv',
                          show_col_types = FALSE) 
```

```{r}
test |> select(Name, Dwt, HP.Total.Propulsion, ME_W_ref_first) |> 
  mutate(test = HP.Total.Propulsion/ME_W_ref_first) |> 
  arrange(desc(test))
```

# Plot raw data

showtext makes fonts work properly for png's, but don't use because not consistent with previous chapter plots

```{r}
# library(showtext)
# showtext_auto()
# 
# train_df |> 
#   ggplot(aes(x = log_report_fc, y = log_cal_fc)) +
#   geom_point() +
#   geom_abline(slope = 1, intercept = 0) +
#   geom_smooth(method = 'lm') +
#   theme_minimal(base_family = 'sans')
#   # theme(panel.grid = element_blank())
# ggsave('test.png', device = 'png', width = 4, height = 2)
```

# Tables

## Optimal parameters table

```{r}
params <- paste0(str_remove(fileprefix, '_Exploration'), 'F', set, '_eval_fc_stats.csv') %>%
  file.path(mltrackeddatapath, .) |> 
  read_csv(show_col_types = FALSE) |> 
  select(Model = class_name, Parameters = params) |> 
  mutate(Model = str_replace_all(Model, regex('(?<!^)(([A-Z][a-z]|(?<=[a-z]))[A-Z])'), ' \\1'),
         Model = str_replace_all(Model, c('Cat Boost' = 'CatBoost',
                                          'Ridge' = 'Ridge Regression'))) |> 
  mutate(Parameters = str_remove_all(Parameters, "\\{|\\}|\\'") |> 
           str_replace_all('_', ' ')) |> 
  separate(Parameters, sep = ',', into = as.character(1:10), fill = 'right') |>
  pivot_longer(-Model, names_to = NULL, values_to = 'Parameters') |> 
  drop_na(Parameters) |> 
  separate(Parameters, into = c('Parameter', 'Value'), sep = ': ') |> 
  mutate(Parameter = ifelse(Parameter=='', 'n/a', Parameter),
         Value = replace_na(Value, 'n/a')) |> 
  arrange(Model)

colored_rows <- params |>
  mutate(test = factor(Model),
         test2 = as.numeric(test) %% 2 == 0)
colored_rows <- which(!colored_rows$test2)

rows_rule_below <- params |> 
  mutate(test = Model != lead(Model))
# last row will be NA, so won't put line below last row, which is what we want

rows_rule_below <- which(rows_rule_below$test)
rows_rule_below

# ncol(params)

params |> 
  kbl(format = 'latex',
      escape = FALSE,
      booktabs = TRUE,
      linesep = c(''),
      align = 'llr') |> 
  collapse_rows(columns = 1,
                latex_hline = 'none',
                valign = 'top') |>
  # row_spec(rows_rule_below,
  #          extra_latex_after = "\\arrayrulecolor{greytext}\\midrule\\arrayrulecolor{black}") |>
  row_spec(row = 0, align = 'l') |>
  row_spec(rows_rule_below,
           extra_latex_after = paste0("\\cmidrule(lr){1-", ncol(params), "}")) |>
  save_kable(file.path(tablepath, paste0(fileprefix, 'tuned_parameters_', set, ".tex")))
params
```

## Train Eval Results Table

```{r}
eval_results <- paste0(str_remove(fileprefix, '_Exploration'), 'F', set, '_eval_fc_stats.csv') %>%
  file.path(mltrackeddatapath, .) |> 
  read_csv(show_col_types = FALSE) |> 
  select(Model = class_name, starts_with('r2'), starts_with('mae'), starts_with('mape')) |> 
  mutate(Model = str_replace_all(Model, regex('(?<!^)(([A-Z][a-z]|(?<=[a-z]))[A-Z])'), ' \\1'),
         Model = str_replace_all(Model, c('Cat Boost' = 'CatBoost',
                                          'Ridge' = 'Ridge Regression'))) |> 
  mutate(across(starts_with('MAPE'), \(x) x*100))

colnames(eval_results) <- colnames(eval_results) |> 
  str_replace_all(c('r2' = 'R$^2$',
                    'mae' = 'MAE (t)',
                    'mape' = 'MAPE (%)'))

colnames(eval_results)
```

```{r}
tablefilepath <- file.path(tablepath, paste0(fileprefix, 'eval_stats_', set, ".tex"))

# split column headers across multiple rows
headers <- get_separate_headers(eval_results, sep = "_")

eval_results |> 
  setNames(headers$colnames) |> # part of column header splitting
  kbl(digits = c(1, rep(3,2), rep(0,2), rep(1,2)),
      format = 'latex',
      escape = FALSE,
      booktabs = TRUE,
      linesep = c('')) |> 
  add_headers_above(headers$rows_indexes) |> # part of column header splitting
  # column_spec(1, width = "12em")
  # column_spec(2, width = "30em") |> 
  row_spec(row = 0, align = 'c') |> 
  save_kable(tablefilepath, float = FALSE)

# Manually include escape character for percent symbol
read_file(tablefilepath) |> 
  str_replace_all('\\%', '\\\\%') |> 
  write_file(tablefilepath)

eval_results
```

## Test Results Table

```{r}
test_results <- paste0(str_remove(fileprefix, '_Exploration'), 'F', set, '_test_fc.csv') %>%
  file.path(mltrackeddatapath, .) |> 
  read_csv(show_col_types = FALSE) |> 
  select(Model = class_name, starts_with('r2'), starts_with('mae'), starts_with('mape')) |> 
  mutate(Model = str_replace_all(Model, regex('(?<!^)(([A-Z][a-z]|(?<=[a-z]))[A-Z])'), ' \\1'),
         Model = str_replace_all(Model, c('Cat Boost' = 'CatBoost',
                                          'Ridge' = 'Ridge Regression'))) |> 
  mutate(across(starts_with('MAPE'), \(x) x*100))

colnames(test_results) <- colnames(test_results) |> 
  str_replace_all(c('r2' = 'R$^2$',
                    'mae' = 'MAE (t)',
                    'mape' = 'MAPE (%)'))

colnames(test_results)

tablefilepath <- file.path(tablepath, paste0(fileprefix, 'test_fc_', set, ".tex"))

# split column headers across multiple rows
headers <- get_separate_headers(test_results, sep = "_")

test_results |> 
  setNames(headers$colnames) |> # part of column header splitting
  kbl(digits = c(1,3,0,1),
      format = 'latex',
      escape = FALSE,
      booktabs = TRUE,
      linesep = c('')) |> 
  add_headers_above(headers$rows_indexes) |> # part of column header splitting
  # column_spec(1, width = "12em")
  # column_spec(2, width = "30em") |> 
  row_spec(row = 0, align = 'c') |> 
  save_kable(tablefilepath, float = FALSE)

# Manually include escape character for percent symbol
read_file(tablefilepath) |>
  str_replace_all('\\%', '\\\\%') |>
  write_file(tablefilepath)

test_results
```

## Summary stats table

### Reported

```{r}
stats_report_filtered <- paste0(str_remove(fileprefix, '_Exploration'), 'F', set, '_desc_stats_filtered_year.csv') %>%
  file.path(mltrackeddatapath, .) |> 
  read_csv(show_col_types = FALSE) |> 
  select(Year = year, starts_with('report'))
# 
colnames(stats_report_filtered) <- colnames(stats_report_filtered) |>
  str_replace_all(c('std' = 'sd (t)',
                  'mean' = 'mean (t)')) |> 
  str_remove_all('report_fc_')

colnames(stats_report_filtered)

stats_report_filtered |> 
  kbl(digits = 0,
      format = 'latex',
      escape = FALSE,
      booktabs = TRUE,
      linesep = c(''),
      align = c('c', rep('r', 3))) |> 
  column_spec(1, width = "4em") |> 
  column_spec(2:4, width = "3em") |> 
  # column_spec(2, width = "30em") |> 
  row_spec(row = 0, align = 'c') |> 
  save_kable(file.path(tablepath, paste0(fileprefix, 'report_filtered_stats_', set, ".tex")),
             float = FALSE)

stats_report_filtered
```

### Calculated

```{r}
stats_cal_filtered <- paste0(str_remove(fileprefix, '_Exploration'), 'F', set, '_desc_stats_filtered_year.csv') %>%
  file.path(mltrackeddatapath, .) |> 
  read_csv(show_col_types = FALSE) |> 
  select(Year = year, starts_with('cal'))
# 
colnames(stats_cal_filtered) <- colnames(stats_cal_filtered) |>
  str_replace_all(c('std' = 'sd (t)',
                    'mean' = 'mean (t)')) |> 
  str_remove_all('cal_fc_')

colnames(stats_cal_filtered)

stats_cal_filtered |> 
  kbl(digits = 0,
      format = 'latex',
      escape = FALSE,
      booktabs = TRUE,
      linesep = c(''),
      align = c('c', rep('r', 3))) |> 
  column_spec(1, width = "4em") |> 
  column_spec(2:4, width = "3em") |> 
  # column_spec(2, width = "30em") |> 
  row_spec(row = 0, align = 'c') |> 
  save_kable(file.path(tablepath, paste0(fileprefix, 'cal_filtered_stats_', set, ".tex")),
             float = FALSE)

stats_cal_filtered
```

### Combined

```{r}
flip_names <- function(name, sep){
  if(str_detect(name, sep)){
    name_list <- str_split(name, sep, simplify = TRUE)
    name <- paste0(name_list[[2]], sep, name_list[[1]])
  }
  return(name)
}
```

```{r}
stats_both <- full_join(stats_report_filtered,
                        stats_cal_filtered |> select(-count),
                        by = 'Year', 
                        suffix = c('_Reported', '_Calculated'))

colnames(stats_both) <- sapply(colnames(stats_both), \(x) flip_names(x, sep = '_'))

stats_both |> 
  kbl(digits = 0,
      format = 'latex',
      escape = FALSE,
      booktabs = TRUE,
      linesep = c(''),
      align = c('c', rep('r', 3))) |> 
  column_spec(1, width = "4em") |> 
  column_spec(2:4, width = "4em") |> 
  header_separate(sep = '_') |> 
  row_spec(row = 0, align = 'c') |> 
  save_kable(file.path(tablepath, paste0(fileprefix, 'both_filtered_stats_', set, ".tex")),
             float = FALSE)

stats_both
```

## Predictor summary stats

```{r}
pred_stats <- paste0(str_remove(fileprefix, '_Exploration'), 'F', set, '_desc_stats_predictors_filtered_set.csv') %>%
  file.path(mltrackeddatapath, .) |> 
  read_csv(show_col_types = FALSE) |> 
  pivot_longer(-set) |> 
  separate(name, into = c('variable', 'stat'), sep = "_(?=[^_]+$)", extra = 'merge') |> 
  unite(set_stat, c("set", "stat")) |> 
  pivot_wider(names_from = set_stat, values_from = value) |> 
  left_join(features_all_desc, by = 'variable') |> 
  mutate(unit = ifelse(is.na(unit),
                          unit,
                          paste0('(', unit, ')'))) |> 
  mutate(across(everything(), \(x) replace_na(x, ''))) |> 
  mutate(name = str_to_title(name)) |> 
  mutate(Name = ifelse(type == 'derived',
                       name,
                       paste(name, unit))) |> 
  mutate(group = factor(group, 
                        ordered = TRUE, 
                        levels = c('characteristic', 'activity', 'calc', 'quality'),
                        labels = c('Ship Characteristics', 'Ship Activity', 'Calculated', 'Data Quality'))) |> 
  arrange(group, name) |> 
  select(Name, starts_with('Train'), starts_with('Test')) |> 
  mutate(across(c(-Name, -contains('count')), 
                \(x) case_when(x < 0.001 ~ format(x, digits = 3, scientific = TRUE),
                               between(x, 0.001, 1) ~ format(round(x, 2), scientific = FALSE),
                               between(x, 1, 100) ~ format(round(x, 1), scientific = FALSE),
                               between(x, 100, 10000) ~ format(round(x, 0), scientific = FALSE),
                               x > 10000 ~ format(x, digits = 3, scientific = TRUE))))

pred_stats |> 
  kbl(digits = 3,
      format = 'latex',
      align = c('l', rep('r', ncol(pred_stats)-1)),
      escape = FALSE,
      booktabs = TRUE) |> 
  header_separate(sep = '_') |> 
  save_kable(file.path(tablepath, paste0(fileprefix, 'predictor_stats_', set, ".tex")),
             float = FALSE)
pred_stats
```
